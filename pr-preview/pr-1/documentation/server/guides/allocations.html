<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>Swift.org - Allocations</title>
  
  <meta name="author" content="Apple Inc." />
  <meta name="viewport" content="width=device-width initial-scale=1" />
  
  <link rel="license" href="/swift-org-website/pr-preview/pr-1//LICENSE.txt" />
  <link rel="stylesheet" media="all" href="/swift-org-website/pr-preview/pr-1//assets/stylesheets/application.css" />
  <link rel="shortcut icon" sizes="16x16 24x24 32x32 48x48 64x64" type="image/vnd.microsoft.icon" href="/swift-org-website/pr-preview/pr-1//favicon.ico" />
  <link rel="apple-touch-icon" href="/swift-org-website/pr-preview/pr-1//apple-touch-icon.png" />
  <link rel="apple-touch-icon" sizes="57x57" href="/swift-org-website/pr-preview/pr-1//apple-touch-icon-57x57.png" />
  <link rel="apple-touch-icon" sizes="72x72" href="/swift-org-website/pr-preview/pr-1//apple-touch-icon-72x72.png" />
  <link rel="apple-touch-icon" sizes="76x76" href="/swift-org-website/pr-preview/pr-1//apple-touch-icon-76x76.png" />
  <link rel="apple-touch-icon" sizes="114x114" href="/swift-org-website/pr-preview/pr-1//apple-touch-icon-114x114.png" />
  <link rel="apple-touch-icon" sizes="120x120" href="/swift-org-website/pr-preview/pr-1//apple-touch-icon-120x120.png" />
  <link rel="apple-touch-icon" sizes="144x144" href="/swift-org-website/pr-preview/pr-1//apple-touch-icon-144x144.png" />
  <link rel="apple-touch-icon" sizes="152x152" href="/swift-org-website/pr-preview/pr-1//apple-touch-icon-152x152.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/swift-org-website/pr-preview/pr-1//apple-touch-icon-180x180.png" />
  <link rel="mask-icon" href="/swift-org-website/pr-preview/pr-1//assets/images/icon-swift.svg" color="#F05339" />
  

  
  <link rel="canonical" href="https://shahmishal.github.io/swift-org-website/pr-preview/pr-1//documentation/server/guides/allocations.html" />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@SwiftLang" />
  
  <meta name="twitter:title" content="Swift.org" />
  <meta name="twitter:description" content="Swift is a general-purpose programming language built using a modern approach to safety, performance, and software design patterns." />
  

  <meta property="og:site_name" content="Swift.org" />
  <meta property="og:image" content="https://shahmishal.github.io/apple-touch-icon-180x180.png" />
  
  
  <meta property="og:title" content="Swift.org" />
  <meta property="og:url" content="https://shahmishal.github.io" />
  <meta property="og:description" content="Swift is a general-purpose programming language built using a modern approach to safety, performance, and software design patterns." />
  
</head>

<body>

<script src="/swift-org-website/pr-preview/pr-1//assets/javascripts/color-scheme-toggle.js"></script>
<header class="site-navigation">
  <div class="wrapper">
    <h1 id="logo">
      <a href="/" title="Swift.org">
        <svg xmlns="http://www.w3.org/2000/svg" xml:space="preserve" viewBox="0 0 191.186 59.391"><path fill="#F05138" d="M59.387 16.45a82.463 82.463 0 0 0-.027-1.792c-.035-1.301-.112-2.614-.343-3.9-.234-1.307-.618-2.523-1.222-3.71a12.464 12.464 0 0 0-5.453-5.452C51.156.992 49.941.609 48.635.374c-1.288-.232-2.6-.308-3.902-.343a85.714 85.714 0 0 0-1.792-.027C42.23 0 41.52 0 40.813 0H18.578c-.71 0-1.419 0-2.128.004-.597.004-1.195.01-1.792.027-.325.009-.651.02-.978.036-.978.047-1.959.133-2.924.307-.98.176-1.908.436-2.811.81A12.503 12.503 0 0 0 3.89 3.89a12.46 12.46 0 0 0-2.294 3.158C.992 8.235.61 9.45.374 10.758c-.231 1.286-.308 2.599-.343 3.9a85.767 85.767 0 0 0-.027 1.792C-.001 17.16 0 17.869 0 18.578v22.235c0 .71 0 1.418.004 2.128.004.597.01 1.194.027 1.791.035 1.302.112 2.615.343 3.901.235 1.307.618 2.523 1.222 3.71a12.457 12.457 0 0 0 5.453 5.453c1.186.603 2.401.986 3.707 1.22 1.287.232 2.6.31 3.902.344.597.016 1.195.023 1.793.027.709.005 1.417.004 2.127.004h22.235c.709 0 1.418 0 2.128-.004.597-.004 1.194-.011 1.792-.027 1.302-.035 2.614-.112 3.902-.343 1.306-.235 2.521-.618 3.707-1.222a12.461 12.461 0 0 0 5.453-5.452c.604-1.187.987-2.403 1.222-3.71.231-1.286.308-2.6.343-3.9.016-.598.023-1.194.027-1.792.004-.71.004-1.419.004-2.129V18.578c0-.71 0-1.419-.004-2.128z"/><path fill="#FFF" d="m47.06 36.66-.004-.004c.066-.224.134-.446.191-.675 2.465-9.821-3.55-21.432-13.731-27.546 4.461 6.048 6.434 13.374 4.681 19.78-.156.571-.344 1.12-.552 1.653-.225-.148-.51-.316-.89-.527 0 0-10.127-6.252-21.103-17.312-.288-.29 5.852 8.777 12.822 16.14-3.284-1.843-12.434-8.5-18.227-13.802.712 1.187 1.558 2.33 2.489 3.43C17.573 23.932 23.882 31.5 31.44 37.314c-5.31 3.25-12.814 3.502-20.285.003a30.646 30.646 0 0 1-5.193-3.098c3.162 5.058 8.033 9.423 13.96 11.97 7.07 3.039 14.1 2.833 19.336.05l-.004.007c.024-.016.055-.032.08-.047.214-.116.428-.234.636-.358 2.516-1.306 7.485-2.63 10.152 2.559.654 1.27 2.041-5.46-3.061-11.74z"/><path id="logotype" d="M81.93 38.542c.465 4.12 4.394 6.822 9.852 6.822 5.185 0 8.924-2.701 8.924-6.44 0-3.22-2.265-5.185-7.478-6.495l-5.048-1.282c-7.26-1.801-10.534-5.077-10.534-10.48 0-6.658 5.813-11.27 14.082-11.27 8.022 0 13.726 4.639 13.917 11.325h-5.32c-.41-4.093-3.74-6.604-8.734-6.604-4.94 0-8.378 2.538-8.378 6.249 0 2.892 2.13 4.612 7.369 5.95l4.202 1.09c8.133 1.993 11.462 5.159 11.462 10.863 0 7.259-5.759 11.816-14.928 11.816-8.514 0-14.327-4.53-14.763-11.543h5.376zM140.049 49.43h-5.35l-6.249-21.776h-.109L122.12 49.43h-5.348l-7.914-28.518h5.184l5.513 22.896h.11l6.221-22.896h5.021l6.277 22.896h.11l5.512-22.896h5.13L140.05 49.43zM151.39 13.244c0-1.718 1.419-3.11 3.138-3.11 1.746 0 3.165 1.392 3.165 3.11 0 1.72-1.419 3.139-3.165 3.139a3.157 3.157 0 0 1-3.139-3.139zm.545 7.669h5.213V49.43h-5.213V20.913zM191.186 25.116v-4.204h-5.513v-6.821h-5.185v6.821h-9.964v-2.51c.027-2.538 1.01-3.603 3.357-3.603.764 0 1.528.083 2.156.192v-4.094a18.193 18.193 0 0 0-2.756-.218c-5.568 0-7.915 2.32-7.915 7.642v2.591h-3.983v4.204h3.983V49.43h5.185V25.116H180.488v16.838c0 5.512 2.101 7.64 7.559 7.64 1.174 0 2.51-.082 3.111-.218v-4.257c-.355.055-1.392.137-1.965.137-2.428 0-3.52-1.147-3.52-3.712V25.116h5.513z"/></svg>

      </a>
    </h1>

    <nav role="navigation">
      <ul class="navigation-links">
        
          <li class="nav-item">
            
              <span class="">
                
                  <a href="/getting-started/" data-text="Get Started">Get Started</a>
                
                
              </span>
            
            
          </li>
        
          <li class="nav-item">
            
              <span class="">
                
                  <a href="/blog/" data-text="Blog">Blog</a>
                
                
              </span>
            
            
          </li>
        
          <li class="nav-item">
            
              <span class="">
                
                  <a href="/documentation/" data-text="Documentation">Documentation</a>
                
                
              </span>
            
            
          </li>
        
          <li class="nav-item">
            
              <span class="">
                
                  <a href="/packages/" data-text="Packages">Packages</a>
                
                
              </span>
            
            
          </li>
        
          <li class="nav-item">
            
              <span class="">
                
                  <a href="/tools/" data-text="Tools">Tools</a>
                
                
              </span>
            
            
          </li>
        
          <li class="nav-item">
            
              <span class="">
                
                  <a href="/community/" data-text="Community">Community</a>
                
                
                  <i>&#9663;</i>
                
              </span>
            
            
              <ul class="nav-submenu" role="menu">
                
                  
                    
                    <li role="presentation">
                    
                      <a href="/community/" role="menuitem">Overview</a>
                    </li>
                  
                
                  
                    
                    <li role="presentation">
                    
                      <a href="/swift-evolution/" role="menuitem">Swift Evolution</a>
                    </li>
                  
                
                  
                    
                    <li role="presentation">
                    
                      <a href="/diversity/" role="menuitem">Diversity</a>
                    </li>
                  
                
                  
                    
                    <li role="presentation">
                    
                      <a href="/mentorship/" role="menuitem">Mentorship</a>
                    </li>
                  
                
                  
                    
                    <li role="presentation">
                    
                      <a href="/contributing/" role="menuitem">Contributing</a>
                    </li>
                  
                
                  
                  <li class="nav-section">Steering Groups</li>
                  
                
                  
                    
                    <li role="presentation">
                    
                      <a href="/language-steering-group/" role="menuitem">Language</a>
                    </li>
                  
                
                  
                    
                    <li role="presentation">
                    
                      <a href="/platform-steering-group/" role="menuitem">Platform</a>
                    </li>
                  
                
                  
                  <li class="nav-section">Workgroups</li>
                  
                
                  
                    
                    <li role="presentation">
                    
                      <a href="/contributor-experience-workgroup/" role="menuitem">Contributor Experience</a>
                    </li>
                  
                
                  
                    
                    <li role="presentation">
                    
                      <a href="/sswg/" role="menuitem">Server</a>
                    </li>
                  
                
                  
                    
                    <li role="presentation">
                    
                      <a href="/website/" role="menuitem">Website</a>
                    </li>
                  
                
                  
                    
                    <li role="presentation">
                    
                      <a href="/cxx-interop-workgroup/" role="menuitem">C++ Interoperability</a>
                    </li>
                  
                
                  
                    
                    <li role="presentation">
                    
                      <a href="/documentation-workgroup/" role="menuitem">Documentation</a>
                    </li>
                  
                
                  
                    
                    <li role="presentation">
                    
                      <a href="/foundation-workgroup/" role="menuitem">Foundation</a>
                    </li>
                  
                
                  
                  <li class="nav-section">Governance</li>
                  
                
                  
                    
                    <li role="presentation">
                    
                      <a href="/code-of-conduct/" role="menuitem">Code of Conduct</a>
                    </li>
                  
                
                  
                    
                    <li role="presentation">
                    
                      <a href="/legal/license.html" role="menuitem">License</a>
                    </li>
                  
                
                  
                    
                    <li role="presentation">
                    
                      <a href="/support/security.html" role="menuitem">Security</a>
                    </li>
                  
                
              </ul>
            
          </li>
        
          <li class="nav-item nav-cta">
            
              <a href="/install/" data-text="Install">Install</a>
            
            
          </li>
        
      </ul>
      <button id="menu-toggle" class="menu-item menu-toggle open" aria-expanded="false" aria-label="Toggle Navigation Menu"></button>
    </nav>
  </div>

  <nav class="mobile-navigation" role="navigation">
    <ul class="mobile-navigation-links">
      
        <li class="nav-item">
          <div class="link-container">
            
              <a href="/getting-started/">Get Started</a>
              

            
          </div>
          
        </li>
      
        <li class="nav-item">
          <div class="link-container">
            
              <a href="/blog/">Blog</a>
              

            
          </div>
          
        </li>
      
        <li class="nav-item">
          <div class="link-container">
            
              <a href="/documentation/">Documentation</a>
              

            
          </div>
          
        </li>
      
        <li class="nav-item">
          <div class="link-container">
            
              <a href="/packages/">Packages</a>
              

            
          </div>
          
        </li>
      
        <li class="nav-item">
          <div class="link-container">
            
              <a href="/tools/">Tools</a>
              

            
          </div>
          
        </li>
      
        <li class="nav-item">
          <div class="link-container">
            
              <a href="/community/">Community</a>
              

            
              <button class="section-toggle" aria-expanded="false" aria-label="Toggle Community Section">
                &#9663;
              </button>
            
          </div>
          
            <ul class="section-menu">
              
                
                  
                    <li>
                  
                    <a href="/community/">Overview</a>
                  </li>
                
              
                
                  
                    <li>
                  
                    <a href="/swift-evolution/">Swift Evolution</a>
                  </li>
                
              
                
                  
                    <li>
                  
                    <a href="/diversity/">Diversity</a>
                  </li>
                
              
                
                  
                    <li>
                  
                    <a href="/mentorship/">Mentorship</a>
                  </li>
                
              
                
                  
                    <li>
                  
                    <a href="/contributing/">Contributing</a>
                  </li>
                
              
                
                  <li class="nav-section">Steering Groups</li>
                
              
                
                  
                    <li>
                  
                    <a href="/language-steering-group/">Language</a>
                  </li>
                
              
                
                  
                    <li>
                  
                    <a href="/platform-steering-group/">Platform</a>
                  </li>
                
              
                
                  <li class="nav-section">Workgroups</li>
                
              
                
                  
                    <li>
                  
                    <a href="/contributor-experience-workgroup/">Contributor Experience</a>
                  </li>
                
              
                
                  
                    <li>
                  
                    <a href="/sswg/">Server</a>
                  </li>
                
              
                
                  
                    <li>
                  
                    <a href="/website/">Website</a>
                  </li>
                
              
                
                  
                    <li>
                  
                    <a href="/cxx-interop-workgroup/">C++ Interoperability</a>
                  </li>
                
              
                
                  
                    <li>
                  
                    <a href="/documentation-workgroup/">Documentation</a>
                  </li>
                
              
                
                  
                    <li>
                  
                    <a href="/foundation-workgroup/">Foundation</a>
                  </li>
                
              
                
                  <li class="nav-section">Governance</li>
                
              
                
                  
                    <li>
                  
                    <a href="/code-of-conduct/">Code of Conduct</a>
                  </li>
                
              
                
                  
                    <li>
                  
                    <a href="/legal/license.html">License</a>
                  </li>
                
              
                
                  
                    <li>
                  
                    <a href="/support/security.html">Security</a>
                  </li>
                
              
            </ul>
          
        </li>
      
        <li class="nav-item">
          <div class="link-container">
            
              <a href="/install/">Install</a>
              

            
          </div>
          
        </li>
      
    </ul>
  </nav>
 </header>

<main role="main">
  <article class="page">
  
    
      <header>
        <h1>Allocations</h1>
      </header>
    
  

  <h2 id="overview">Overview</h2>
<p>In server-side Swift applications, memory allocations are fundamental for various tasks like creating objects, manipulating data structures, and managing resources. Swift allocates memory resources as needed and provides built-in memory management mechanisms, such as automatic reference counting (ARC), to handle allocations, deallocations, and memory ownership.</p>

<p>Allocations aid in optimizing memory usage by allocating the precise amount of memory required for each object or data structure, reducing memory wastage and improving application performance. However, Swift allocations can be padded to enforce memory alignment requirements for data types or structures that need to be accessed efficiently by the hardware, reducing the risk of misaligned memory access issues and improving performance.</p>

<p>Additionally, proper allocation management prevents memory leaks and ensures that memory is released when it is no longer needed. This helps in maintaining the stability and reliability of server applications.</p>

<h2 id="heaps-and-stacks">Heaps and stacks</h2>
<p>Generally speaking, Swift has two fundamental locations for memory allocations: <strong>Heaps</strong> and <strong>Stacks</strong>.</p>

<p>Swift automatically allocates memory in either the heap or the stack data structure.</p>

<p>For high-performance software in Swift, understanding the source of your heap allocations and reducing the number of allocations your software provides is paramount. Identifying these questions is similar to identifying other performance questions, such as:</p>

<ul>
  <li>Where are the resources being allocated before optimizing performance?</li>
  <li>What types of resources are used? CPU? Memory? Heap allocations?</li>
</ul>

<blockquote>
  <p>Note: While heap allocations can be relatively expensive regarding computational overhead, they provide flexibility and dynamic memory management capabilities essential for tasks like working with variable-sized or dynamic data structures.</p>
</blockquote>

<h2 id="profiling">Profiling</h2>
<p>You can use different tools and techniques to profile your Swift code, depending on the specific requirements of your project. Some commonly used profiling techniques include:</p>

<ul>
  <li>Using OS vendor-supplied profiling tools like <a href="https://help.apple.com/instruments/mac/current/#/dev7b09c84f5">Instruments</a> on macOS or <a href="https://www.swift.org/server/guides/linux-perf.html"><code class="language-plaintext highlighter-rouge">perf</code></a> on Linux.</li>
  <li>Adding manual timing measurements using techniques like adding timestamps before and after critical code sections.</li>
  <li>Leveraging performance profiling libraries and frameworks for Swift, such as <a href="https://swiftpackageregistry.com/RuntimeTools/SwiftMetrics">SwiftMetrics</a> or <a href="https://github.com/XCGLogger/">XCGLogger</a>.</li>
</ul>

<p>For macOS, you can use the <a href="https://developer.apple.com/documentation/xcode/gathering-information-about-memory-use#Profile-your-app-using-the-Allocations-instrument">Allocations instrument</a> in <a href="https://developer.apple.com/xcode/">Xcode</a> Instruments to help you analyze and optimize memory usage in your apps. The Allocations instrument tracks the size and number of all heap and anonymous virtual memory allocations and organizes them by category.</p>

<p>If your production workloads run on Linux instead of macOS, the number of allocations can differ significantly depending on your setup.</p>

<p><em>This document mainly focuses on the number of heap allocations and not their size.</em></p>

<h2 id="getting-started">Getting started</h2>
<p>Swift’s optimizer produces faster code and allocates less memory in <code class="language-plaintext highlighter-rouge">release</code> mode. By profiling your Swift code in the <code class="language-plaintext highlighter-rouge">release</code> mode and optimizing based on the results, you can achieve better performance and efficiency in your applications.</p>

<p>Follow the steps below:</p>

<p>Step 1. <strong>Build your code</strong> in <code class="language-plaintext highlighter-rouge">release</code> mode by running this command:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>swift run <span class="nt">-c</span> release
</code></pre></div></div>

<p>Step 2. <a href="https://www.swift.org/server/guides/linux-perf.html"><strong>Install <code class="language-plaintext highlighter-rouge">perf</code></strong></a> to profile your code for your environment to gather performance-related data and optimize the performance of your Swift server applications.</p>

<p>Step 3. <strong>Clone the FlameGraph project</strong> to generate a flame graph visualization that helps you quickly identify hotspots in the codebase, visualize call paths, understand the flow of execution, and optimize performance. To generate a flame graph, you will need to clone the <a href="https://github.com/brendangregg/FlameGraph"><code class="language-plaintext highlighter-rouge">FlameGraph</code></a> repository on your machine or into a container, making it available at <code class="language-plaintext highlighter-rouge">~/FlameGraph</code>.</p>

<p>Run this command to clone the <code class="language-plaintext highlighter-rouge">https://github.com/brendangregg/FlameGraph</code> repository in <code class="language-plaintext highlighter-rouge">~/FlameGraph</code>:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/brendangregg/FlameGraph
</code></pre></div></div>

<p>When running in Docker, use this command to bind-mount the <code class="language-plaintext highlighter-rouge">FlameGraph</code> repository into the container:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">-it</span> <span class="nt">--rm</span> <span class="se">\</span>
           <span class="nt">--privileged</span> <span class="se">\</span>
           <span class="nt">-v</span> <span class="s2">"/path/to/FlameGraphOnYourMachine:/FlameGraph:ro"</span> <span class="se">\</span>
           <span class="nt">-v</span> <span class="s2">"</span><span class="nv">$PWD</span><span class="s2">:PWD"</span> <span class="nt">-w</span> <span class="s2">"</span><span class="nv">$PWD</span><span class="s2">"</span> <span class="se">\</span>
           swift:latest
</code></pre></div></div>

<p>By visually highlighting the most frequently called functions or the functions consuming the most processing time, you can focus your optimization efforts on improving the performance of critical code paths.</p>

<h2 id="tools">Tools</h2>
<p>You can identify areas for optimization and make informed decisions to improve the performance and efficiency of your Swift server code using the <a href="https://perf.wiki.kernel.org/index.php/Main_Page">Linux <code class="language-plaintext highlighter-rouge">perf</code></a> tool.</p>

<p>The <code class="language-plaintext highlighter-rouge">perf</code> tool is a performance profiling and analysis tool available on Linux systems. Although it is not specific to Swift, it can be valuable for profiling Swift code on the server for the following reasons:</p>

<ul>
  <li><strong>Low overhead</strong> which means it can collect performance data with minimal impact on the execution of your Swift code.</li>
  <li><strong>Rich set of features</strong> like CPU profiling, memory profiling, and event-based sampling.</li>
  <li><strong>Flame graph generation</strong> to help you understand the relative time spent in different areas of your code and identify performance bottlenecks.</li>
  <li><strong>System-level profiling</strong> gathers performance data at the kernel level, analyzes system-wide events, and understands the impact of other processes or system components on the performance of your Swift application.</li>
  <li><strong>Flexibility and extensibility</strong> allow you to customize the types of events you want to profile, set sampling rates, specify filters, and more.</li>
</ul>

<blockquote>
  <p>Tip 1: If you’re running <code class="language-plaintext highlighter-rouge">perf</code> in a Docker container, you will need a privileged container to provide the necessary permissions and access to the tool to gather performance data.</p>
</blockquote>

<blockquote>
  <p>Tip 2: Prefix the commands with <code class="language-plaintext highlighter-rouge">sudo</code> if you need <code class="language-plaintext highlighter-rouge">root</code> access.
See <a href="https://www.swift.org/server/guides/linux-perf.html">Getting <code class="language-plaintext highlighter-rouge">perf</code> to work</a> for more information.</p>
</blockquote>

<h2 id="installing-a-perf-user-probe">Installing a perf user probe</h2>
<p>As previously mentioned, this document’s example programs focus on counting the <em>number</em> of allocations.</p>

<p>Most allocations use a Swift program’s <code class="language-plaintext highlighter-rouge">malloc</code> function on Linux. Installing <code class="language-plaintext highlighter-rouge">perf</code> user probes on the allocation function provides information about when an allocation function is called.</p>

<p>In this instance, a user probe was installed for all allocation functions because Swift uses other functions like <code class="language-plaintext highlighter-rouge">calloc</code> and <code class="language-plaintext highlighter-rouge">posix_memalign</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># figures out the path to libc</span>
<span class="nv">libc_path</span><span class="o">=</span><span class="si">$(</span><span class="nb">readlink</span> <span class="nt">-e</span> /lib64/libc.so.6 /lib/x86_64-linux-gnu/libc.so.6<span class="si">)</span>

<span class="c"># delete all existing user probes on libc (instead of * you can also list them individually)</span>
perf probe <span class="nt">--del</span> <span class="s1">'probe_libc:*'</span>

<span class="c"># installs a probe on `malloc`, `calloc`, and `posix_memalign`</span>
perf probe <span class="nt">-x</span> <span class="s2">"</span><span class="nv">$libc_path</span><span class="s2">"</span> <span class="nt">--add</span> malloc <span class="nt">--add</span> calloc <span class="nt">--add</span> posix_memalign
</code></pre></div></div>

<p>Subsequently, an event in <code class="language-plaintext highlighter-rouge">perf</code> will trigger whenever one of the allocation functions is called.</p>

<p>The output should look like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Added new events:
  probe_libc:malloc    (on malloc in /usr/lib/x86_64-linux-gnu/libc-2.31.so)
  probe_libc:calloc    (on calloc in /usr/lib/x86_64-linux-gnu/libc-2.31.so)
  probe_libc:posix_memalign (on posix_memalign in /usr/lib/x86_64-linux-gnu/libc-2.31.so)

[...]
</code></pre></div></div>

<p>Here, you can see that <code class="language-plaintext highlighter-rouge">perf</code> triggers new events <code class="language-plaintext highlighter-rouge">probe_libc:malloc</code>; <code class="language-plaintext highlighter-rouge">probe_libc:calloc</code> each time the respective function is called.</p>

<p>To confirm the user probe <code class="language-plaintext highlighter-rouge">probe_libc:malloc</code> works, run this command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>perf <span class="nb">stat</span> <span class="nt">-e</span> probe_libc:malloc <span class="nt">--</span> bash <span class="nt">-c</span> <span class="s1">'echo Hello World'</span>
</code></pre></div></div>

<p>The output should look similar to this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Hello World

 Performance counter stats for 'bash -c echo Hello World':

              1021      probe_libc:malloc

       0.003840500 seconds time elapsed

       0.000000000 seconds user
       0.003867000 seconds sys
</code></pre></div></div>

<p>In this case, it appears the user probe called the allocation functions 1021 times.</p>

<blockquote>
  <p>Important: If the probe called the allocation functions 0 times, it would indicate an error.</p>
</blockquote>

<h2 id="running-allocation-analysis">Running allocation analysis</h2>
<p>By running allocation analysis, you can gain a better understanding of the memory usage patterns in your application and identify and fix memory issues such as leaks or inefficient usage, ultimately improving the performance and stability of your code.</p>

<h3 id="example-program">Example program</h3>
<p>Once you’ve confirmed the user probe on <code class="language-plaintext highlighter-rouge">malloc</code> is working, you can analyze the allocations of a program. For instance, you can analyze a program that performs ten subsequent HTTP requests using <a href="https://github.com/swift-server/async-http-client">AsyncHTTPClient</a>.</p>

<p>Analyzing a program using AsyncHTTPClient can help optimize its performance, improve error handling, ensure proper concurrency and threading, enhance code readability and maintainability, and assess scalability considerations.</p>

<p>Here’s an example of the program source code with the following dependencies:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">dependencies</span><span class="p">:</span> <span class="p">[</span>
    <span class="o">.</span><span class="nf">package</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="s">"https://github.com/swift-server/async-http-client.git"</span><span class="p">,</span> <span class="nv">from</span><span class="p">:</span> <span class="s">"1.3.0"</span><span class="p">),</span>
    <span class="o">.</span><span class="nf">package</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="s">"https://github.com/apple/swift-nio.git"</span><span class="p">,</span> <span class="nv">from</span><span class="p">:</span> <span class="s">"2.29.0"</span><span class="p">),</span>
    <span class="o">.</span><span class="nf">package</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="s">"https://github.com/apple/swift-log.git"</span><span class="p">,</span> <span class="nv">from</span><span class="p">:</span> <span class="s">"1.4.2"</span><span class="p">),</span>
<span class="p">],</span>
</code></pre></div></div>

<p>An example program using AsyncHTTPClient can be written as:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">import</span> <span class="kt">AsyncHTTPClient</span>
<span class="kd">import</span> <span class="kt">NIO</span>
<span class="kd">import</span> <span class="kt">Logging</span>

<span class="k">let</span> <span class="nv">urls</span> <span class="o">=</span> <span class="kt">Array</span><span class="p">(</span><span class="nv">repeating</span><span class="p">:</span><span class="s">"http://httpbin.org/get"</span><span class="p">,</span> <span class="nv">count</span><span class="p">:</span> <span class="mi">10</span><span class="p">)</span>
<span class="k">var</span> <span class="nv">logger</span> <span class="o">=</span> <span class="kt">Logger</span><span class="p">(</span><span class="nv">label</span><span class="p">:</span> <span class="s">"ahc-alloc-demo"</span><span class="p">)</span>

<span class="n">logger</span><span class="o">.</span><span class="nf">info</span><span class="p">(</span><span class="s">"running HTTP requests"</span><span class="p">,</span> <span class="nv">metadata</span><span class="p">:</span> <span class="p">[</span><span class="s">"count"</span><span class="p">:</span> <span class="s">"</span><span class="se">\(</span><span class="n">urls</span><span class="o">.</span><span class="n">count</span><span class="se">)</span><span class="s">"</span><span class="p">])</span>
<span class="kt">MultiThreadedEventLoopGroup</span><span class="o">.</span><span class="n">withCurrentThreadAsEventLoop</span> <span class="p">{</span> <span class="n">eventLoop</span> <span class="k">in</span>
    <span class="k">let</span> <span class="nv">httpClient</span> <span class="o">=</span> <span class="kt">HTTPClient</span><span class="p">(</span><span class="nv">eventLoopGroupProvider</span><span class="p">:</span> <span class="o">.</span><span class="nf">shared</span><span class="p">(</span><span class="n">eventLoop</span><span class="p">),</span>
                                <span class="nv">backgroundActivityLogger</span><span class="p">:</span> <span class="n">logger</span><span class="p">)</span>

    <span class="kd">func</span> <span class="nf">doRemainingRequests</span><span class="p">(</span><span class="n">_</span> <span class="nv">remaining</span><span class="p">:</span> <span class="kt">ArraySlice</span><span class="o">&lt;</span><span class="kt">String</span><span class="o">&gt;</span><span class="p">,</span>
                             <span class="nv">overallResult</span><span class="p">:</span> <span class="kt">EventLoopPromise</span><span class="o">&lt;</span><span class="kt">Void</span><span class="o">&gt;</span><span class="p">,</span>
                             <span class="nv">eventLoop</span><span class="p">:</span> <span class="kt">EventLoop</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">var</span> <span class="nv">remaining</span> <span class="o">=</span> <span class="n">remaining</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">first</span> <span class="o">=</span> <span class="n">remaining</span><span class="o">.</span><span class="nf">popFirst</span><span class="p">()</span> <span class="p">{</span>
            <span class="n">httpClient</span><span class="o">.</span><span class="nf">get</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="n">first</span><span class="p">,</span> <span class="nv">logger</span><span class="p">:</span> <span class="n">logger</span><span class="p">)</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="p">[</span><span class="n">remaining</span><span class="p">]</span> <span class="n">_</span> <span class="k">in</span>
                <span class="n">eventLoop</span><span class="o">.</span><span class="n">execute</span> <span class="p">{</span> <span class="c1">// for shorter stacks</span>
                    <span class="nf">doRemainingRequests</span><span class="p">(</span><span class="n">remaining</span><span class="p">,</span> <span class="nv">overallResult</span><span class="p">:</span> <span class="n">overallResult</span><span class="p">,</span> <span class="nv">eventLoop</span><span class="p">:</span> <span class="n">eventLoop</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">}</span><span class="o">.</span><span class="n">whenFailure</span> <span class="p">{</span> <span class="n">error</span> <span class="k">in</span>
                <span class="n">overallResult</span><span class="o">.</span><span class="nf">fail</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">overallResult</span><span class="o">.</span><span class="nf">succeed</span><span class="p">(())</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">let</span> <span class="nv">promise</span> <span class="o">=</span> <span class="n">eventLoop</span><span class="o">.</span><span class="nf">makePromise</span><span class="p">(</span><span class="nv">of</span><span class="p">:</span> <span class="kt">Void</span><span class="o">.</span><span class="k">self</span><span class="p">)</span>
    <span class="c1">// Kick off the process</span>
    <span class="nf">doRemainingRequests</span><span class="p">(</span><span class="n">urls</span><span class="p">[</span><span class="o">...</span><span class="p">],</span>
                        <span class="nv">overallResult</span><span class="p">:</span> <span class="n">promise</span><span class="p">,</span>
                        <span class="nv">eventLoop</span><span class="p">:</span> <span class="n">eventLoop</span><span class="p">)</span>

    <span class="n">promise</span><span class="o">.</span><span class="n">futureResult</span><span class="o">.</span><span class="n">whenComplete</span> <span class="p">{</span> <span class="n">result</span> <span class="k">in</span>
        <span class="k">switch</span> <span class="n">result</span> <span class="p">{</span>
        <span class="k">case</span> <span class="o">.</span><span class="nv">success</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="nf">info</span><span class="p">(</span><span class="s">"all HTTP requests succeeded"</span><span class="p">)</span>
        <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="nf">error</span><span class="p">(</span><span class="s">"HTTP request failure"</span><span class="p">,</span> <span class="nv">metadata</span><span class="p">:</span> <span class="p">[</span><span class="s">"error"</span><span class="p">:</span> <span class="s">"</span><span class="se">\(</span><span class="n">error</span><span class="se">)</span><span class="s">"</span><span class="p">])</span>
        <span class="p">}</span>

        <span class="n">httpClient</span><span class="o">.</span><span class="n">shutdown</span> <span class="p">{</span> <span class="n">maybeError</span> <span class="k">in</span>
            <span class="k">if</span> <span class="k">let</span> <span class="nv">error</span> <span class="o">=</span> <span class="n">maybeError</span> <span class="p">{</span>
                <span class="n">logger</span><span class="o">.</span><span class="nf">error</span><span class="p">(</span><span class="s">"AHC shutdown failed"</span><span class="p">,</span> <span class="nv">metadata</span><span class="p">:</span> <span class="p">[</span><span class="s">"error"</span><span class="p">:</span> <span class="s">"</span><span class="se">\(</span><span class="n">error</span><span class="se">)</span><span class="s">"</span><span class="p">])</span>
            <span class="p">}</span>
            <span class="n">eventLoop</span><span class="o">.</span><span class="n">shutdownGracefully</span> <span class="p">{</span> <span class="n">maybeError</span> <span class="k">in</span>
                <span class="k">if</span> <span class="k">let</span> <span class="nv">error</span> <span class="o">=</span> <span class="n">maybeError</span> <span class="p">{</span>
                    <span class="n">logger</span><span class="o">.</span><span class="nf">error</span><span class="p">(</span><span class="s">"EventLoop shutdown failed"</span><span class="p">,</span> <span class="nv">metadata</span><span class="p">:</span> <span class="p">[</span><span class="s">"error"</span><span class="p">:</span> <span class="s">"</span><span class="se">\(</span><span class="n">error</span><span class="se">)</span><span class="s">"</span><span class="p">])</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">logger</span><span class="o">.</span><span class="nf">info</span><span class="p">(</span><span class="s">"exiting"</span><span class="p">)</span>
</code></pre></div></div>

<p>If running a program as a Swift package, compile it in the <code class="language-plaintext highlighter-rouge">release</code> mode first, using this command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>swift build <span class="nt">-c</span> release
</code></pre></div></div>

<p>A binary called <code class="language-plaintext highlighter-rouge">.build/release/your-program-name</code> should render and can be analyzed to get the number of allocations.</p>

<h3 id="counting-allocations">Counting allocations</h3>
<p>Counting allocations and visualizing them as a graph can help you analyze memory utilization, profile memory usage, optimize performance, refactor and optimize code, and debug memory-related issues in your program.</p>

<p>Before visualizing the allocations as a flame graph, start with an analysis using the binary to get the number of allocations by running the command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>perf <span class="nb">stat</span> <span class="nt">-e</span> <span class="s1">'probe_libc:*'</span> <span class="nt">--</span> .build/release/your-program-name
</code></pre></div></div>

<p>This command instructs <code class="language-plaintext highlighter-rouge">perf</code> to run your program and count the number of times the user probe <code class="language-plaintext highlighter-rouge">probe_libc:malloc</code> was hit or allocated memory within your application.</p>

<p>The output should look similar to this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Performance counter stats for '.build/release/your-program-name':

                68      probe_libc:posix_memalign
                35      probe_libc:calloc_1
                 0      probe_libc:calloc
              2977      probe_libc:malloc

[...]
</code></pre></div></div>

<p>In this instance, the program allocated 2977 times through <code class="language-plaintext highlighter-rouge">malloc</code> and a small number of times through the other allocation functions.</p>

<p>It’s important to note that the <code class="language-plaintext highlighter-rouge">-e probe_libc:*</code> command is used instead of individually listing every event such as:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">-e probe_libc: malloc</code></li>
  <li><code class="language-plaintext highlighter-rouge">probe_libc:calloc</code></li>
  <li><code class="language-plaintext highlighter-rouge">probe_libc:calloc_1</code></li>
  <li><code class="language-plaintext highlighter-rouge">probe_libc:posix_memalign</code></li>
</ul>

<blockquote>
  <p>Tip: This approach assumes you don’t have <em>other</em> <code class="language-plaintext highlighter-rouge">perf</code> user probes installed. If other <code class="language-plaintext highlighter-rouge">perf</code> user probes are installed, you need to specify each event you want to use individually.</p>
</blockquote>

<h3 id="collecting-raw-data">Collecting raw data</h3>
<p>Collecting raw data is crucial for obtaining an accurate representation of the system’s behavior, performing detailed performance analysis and debugging, analyzing trends, enabling profiling flexibility, and guiding performance optimization efforts.</p>

<p>The <code class="language-plaintext highlighter-rouge">perf</code> command doesn’t allow for creating live graphs while the program is running. However, the <a href="https://perf.wiki.kernel.org/index.php/Main_Page">Linux Perf tool</a> provides a <code class="language-plaintext highlighter-rouge">perf record</code>  utility command that captures performance events for later analysis. The collected data can then be transformed into a graph.</p>

<p>In general, the command <code class="language-plaintext highlighter-rouge">perf record</code> can be used to run the program and <code class="language-plaintext highlighter-rouge">libc_probe:malloc</code> to collect information, as shown here:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>perf record <span class="nt">--call-graph</span> dwarf,16384 <span class="se">\</span>
     <span class="nt">-m</span> 50000 <span class="se">\</span>
     <span class="nt">-e</span> <span class="s1">'probe_libc:*'</span> <span class="nt">--</span> <span class="se">\</span>
     .build/release/your-program-name
</code></pre></div></div>

<p>Breaking down this command provides the following construct:</p>

<ul>
  <li>The <code class="language-plaintext highlighter-rouge">perf record</code> command instructs <code class="language-plaintext highlighter-rouge">perf</code> to record data.</li>
  <li>The <code class="language-plaintext highlighter-rouge">--call-graph dwarf,16384</code> command instructs <code class="language-plaintext highlighter-rouge">perf</code> to use the <a href="http://www.dwarfstd.org/">debugging with attributed record formats (DWARF)</a> information to create the call graphs. It also sets the maximum stack dump size to 16k, which should be enough information for full stack traces.
    <ul>
      <li>Although using DWARF is slow (see below), it creates the best call graphs.</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">-m 50000</code> indicates the size of the ring buffer that <code class="language-plaintext highlighter-rouge">perf</code> uses and outputs in multiples of <code class="language-plaintext highlighter-rouge">PAGE_SIZE</code> (usually 4kB).
    <ul>
      <li>A significant buffer is necessary when using DWARF to prevent data loss.</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">-e 'probe_libc:*'</code> records the data when the <code class="language-plaintext highlighter-rouge">malloc</code>; <code class="language-plaintext highlighter-rouge">calloc</code>; and other <code class="language-plaintext highlighter-rouge">malloc/calloc/...</code> user probes fire.
    <ul>
      <li>The fire event occurs when the probe is triggered or executed, capturing relevant information about the allocation for further analysis and debugging.</li>
    </ul>
  </li>
</ul>

<p>Your program output should look similar to this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;your program's output&gt;
[ perf record: Woken up 2 times to write data ]
[ perf record: Captured and wrote 401.088 MB perf.data (49640 samples) ]
</code></pre></div></div>

<p>By placing user probes at strategic points in your codebase, you can track and log allocation events to gain insights into memory allocation patterns, identify potential performance issues or memory leaks, and analyze memory usage in your application.</p>

<blockquote>
  <p>Important: If the <code class="language-plaintext highlighter-rouge">perf</code> output returns <code class="language-plaintext highlighter-rouge">lost chunks</code> and makes a <code class="language-plaintext highlighter-rouge">check the IO/CPU overload!</code> request, see <strong>Overcoming lost chunks of data</strong> below.</p>
</blockquote>

<h3 id="creating-flame-graphs">Creating flame graphs</h3>
<p>Once you’ve successfully recorded data using <code class="language-plaintext highlighter-rouge">perf record</code>, you can invoke the following command to produce an SVG file with the flame graph:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>perf script | <span class="se">\</span>
    /FlameGraph/stackcollapse-perf.pl - | <span class="se">\</span>
    swift demangle <span class="nt">--simplified</span> | <span class="se">\</span>
    /FlameGraph/flamegraph.pl <span class="nt">--countname</span> allocations <span class="se">\</span>
        <span class="nt">--width</span> 1600 <span class="o">&gt;</span> out.svg
</code></pre></div></div>

<p>Here’s a breakdown of this command construct:</p>

<ul>
  <li>The <code class="language-plaintext highlighter-rouge">perf</code> script command places the binary information into a textual form that <code class="language-plaintext highlighter-rouge">perf record</code> captured.</li>
  <li>The <code class="language-plaintext highlighter-rouge">stackcollapse-perf</code> command transforms the stacks that <code class="language-plaintext highlighter-rouge">perf script</code> generated into the correct format for flame graphs.</li>
  <li>The <code class="language-plaintext highlighter-rouge">swift demangle --simplified</code> command converts the symbol names to a human-readable format.</li>
  <li>The last two commands create the flame graph based on the number of allocations.</li>
</ul>

<p>Once the command has been completed, an SVG file is generated that you can open in your browser.</p>

<blockquote>
  <p>Note: Lengthy run times may result depending on the data size, algorithm complexity, resource limitations such as CPU power or memory, poorly optimized or inefficient code, external services, APIs, or network latency causing a slowdown.</p>
</blockquote>

<h3 id="reading-flame-graphs">Reading flame graphs</h3>
<p>This flame graph is a direct result of the example program in this section. Hover over the stack frames to get more information, or click on any stack frame to zoom in on a sub-tree.</p>

<p><img src="/assets/images/server-guides/perf-malloc-full.svg" alt="Flame graph" /></p>

<ul>
  <li>
    <p>When interpreting flame <em>graphs</em>, the X-axis means the <strong>count</strong> and not time. The arrangement of the stack (left or right) is not determined by when that stack was live, unlike flame <em>charts</em>.</p>
  </li>
  <li>This flame graph is not a CPU flame graph but an allocation flame graph, where one sample indicates one allocation and not time spent on the CPU.</li>
  <li>
    <p>The wide stack frames don’t (necessarily) allocate directly, meaning the function, or something the function called, allocated numerous times.</p>

    <ul>
      <li>For example, <code class="language-plaintext highlighter-rouge">BaseSocketChannel.readable</code> is a wide frame, but its function does not allocate directly. Instead, it called other functions, such as other parts of SwiftNIO and AsyncHTTPClient, that allocated considerably.</li>
    </ul>
  </li>
</ul>

<h2 id="allocation-flame-graphs-on-macos">Allocation flame graphs on macOS</h2>
<p>Although much of this tutorial focuses on the <code class="language-plaintext highlighter-rouge">perf</code> tool, you can create the same graphs using macOS.</p>

<p>Step 1. To get started, collect the raw data using the <a href="https://en.wikipedia.org/wiki/DTrace">DTrace</a> framework by running this command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>dtrace <span class="nt">-n</span> <span class="s1">'pid$target::malloc:entry,pid$target::posix_memalign:entry,pid$target::calloc:entry,pid$target::malloc_zone_malloc:entry,pid$target::malloc_zone_calloc:entry,pid$target::malloc_zone_memalign:entry { @s[ustack(100)] = count(); } ::END { printa(@s); }'</span> <span class="nt">-c</span> .build/release/your-program <span class="o">&gt;</span> raw.stacks
</code></pre></div></div>

<p>Like Linux’s <code class="language-plaintext highlighter-rouge">perf</code> user probes, DTrace also uses probes. The previous command instructs <code class="language-plaintext highlighter-rouge">dtrace</code> to aggregate the number of calls to the allocation function equivalents:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">malloc</code></li>
  <li><code class="language-plaintext highlighter-rouge">posix_memalign</code></li>
  <li><code class="language-plaintext highlighter-rouge">calloc</code></li>
  <li><code class="language-plaintext highlighter-rouge">malloc_zone_*</code></li>
</ul>

<blockquote>
  <p>Note: On Apple platforms, Swift uses a slightly larger number of allocation functions than Linux.</p>
</blockquote>

<p>Step 2. Once the data is collected, run this command to create an SVG file:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat </span>raw.stacks |<span class="se">\</span>
    /FlameGraph/stackcollapse.pl - | <span class="se">\</span>
    swift demangle <span class="nt">--simplified</span> | <span class="se">\</span>
    /FlameGraph/flamegraph.pl <span class="nt">--countname</span> allocations <span class="se">\</span>

        <span class="nt">--width</span> 1600 <span class="o">&gt;</span> out.svg
</code></pre></div></div>

<p>You will notice this command is similar to the <code class="language-plaintext highlighter-rouge">perf</code> invocation, except:</p>
<ul>
  <li>The command <code class="language-plaintext highlighter-rouge">cat raw.stacks</code> replaces the <code class="language-plaintext highlighter-rouge">perf script</code> command since <code class="language-plaintext highlighter-rouge">dtrace</code> already includes a textual data file.</li>
  <li>The command <code class="language-plaintext highlighter-rouge">stackcollapse.pl</code>, which parses <code class="language-plaintext highlighter-rouge">dtrace</code> aggregation output, replaces the <code class="language-plaintext highlighter-rouge">stackcollapse-perf.pl</code> command, which parses the <code class="language-plaintext highlighter-rouge">perf script</code> output.</li>
</ul>

<h2 id="other-perf-tricks">Other perf tricks</h2>

<h3 id="swifts-allocation-patterns">Swift’s allocation patterns</h3>
<p>Optimizing memory allocations and improving code efficiency based on the information provided by the flame graph can help make your Swift code more performant and visually appealing. The shape of allocations in Swift can vary depending on the type of memory being allocated and the way it is used.</p>

<p>Some common shapes of allocations in Swift include:</p>

<ul>
  <li>Single object allocations</li>
  <li>Collection allocations</li>
  <li>Strings</li>
  <li>Function call stacks</li>
  <li>Protocol existentials</li>
  <li>Structures and classes</li>
</ul>

<p>For example, a class instance (which allocates) calls <code class="language-plaintext highlighter-rouge">swift_allocObject</code>, which calls <code class="language-plaintext highlighter-rouge">swift_slowAlloc</code>, which calls <code class="language-plaintext highlighter-rouge">malloc</code> that contains the user probe.</p>

<h3 id="prettifying-allocation-patterns">“Prettifying” allocation patterns</h3>
<p>To make your flame graph look good (after demangling the collapsed stacks) insert the following code into the Linux <code class="language-plaintext highlighter-rouge">perf script</code> code (above) by:</p>

<ul>
  <li>Removing <code class="language-plaintext highlighter-rouge">specialized</code> and replacing it with <code class="language-plaintext highlighter-rouge">swift_allocObject</code>.</li>
  <li>Calling <code class="language-plaintext highlighter-rouge">swift_slowAlloc</code>, which calls <code class="language-plaintext highlighter-rouge">malloc</code>.</li>
  <li>Using an <code class="language-plaintext highlighter-rouge">A</code> for allocation.</li>
</ul>

<p>These changes should look like this:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sed</span> <span class="nt">-e</span> <span class="s1">'s/specialized //g'</span> <span class="se">\</span>
    <span class="nt">-e</span> <span class="s1">'s/;swift_allocObject;swift_slowAlloc;__libc_malloc/;A/g'</span>
</code></pre></div></div>

<p>To produce a visually appealing SVG file flame graph when analyzing memory allocations in Swift, use the complete command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>perf script | <span class="se">\</span>
    /FlameGraph/stackcollapse-perf.pl - | <span class="se">\</span>
    swift demangle <span class="nt">--simplified</span> | <span class="se">\</span>
    <span class="nb">sed</span> <span class="nt">-e</span> <span class="s1">'s/specialized //g'</span> <span class="se">\</span>
        <span class="nt">-e</span> <span class="s1">'s/;swift_allocObject;swift_slowAlloc;__libc_malloc/;A/g'</span> | <span class="se">\</span>
    /FlameGraph/flamegraph.pl <span class="nt">--countname</span> allocations <span class="nt">--flamechart</span> <span class="nt">--hash</span> <span class="se">\</span>
    <span class="o">&gt;</span> out.svg
</code></pre></div></div>

<h2 id="overcoming-lost-chunks-of-data">Overcoming lost chunks of data</h2>
<p>When using perf with the DWARF call stack unwinding, you may encounter this issue:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[ perf record: Woken up 189 times to write data ]
Warning:
Processed 4346 events and lost 144 chunks!

Check IO/CPU overload!

[ perf record: Captured and wrote 30.868 MB perf.data (3817 samples) ]
</code></pre></div></div>

<p>If <code class="language-plaintext highlighter-rouge">perf</code> indicates it lost several <em>chunks</em>, it means it lost data. When <code class="language-plaintext highlighter-rouge">perf</code> loses data, you can use these options to help resolve the issue:</p>

<ul>
  <li>Reduce the amount of work your program performs.
    <ul>
      <li>For every allocation, <code class="language-plaintext highlighter-rouge">perf</code> records a stack trace.</li>
    </ul>
  </li>
  <li>Reduce the maximum <em>stack dump</em> that <code class="language-plaintext highlighter-rouge">perf</code> records by changing the <code class="language-plaintext highlighter-rouge">--call-graph dwarf</code> parameter. 
For example, change to: <code class="language-plaintext highlighter-rouge">--call-graph dwarf,2048</code>
    <ul>
      <li>The default records a maximum of 4096 bytes, rendering deep stacks. If you don’t need high-volume output, you can reduce this number. However, the flame graph may display <code class="language-plaintext highlighter-rouge">[unknown]</code> stack frames, meaning missing stack frames exist (in units of bytes).</li>
    </ul>
  </li>
  <li>Increase the number of the <code class="language-plaintext highlighter-rouge">-m</code> parameter, which is the size of the ring buffer that <code class="language-plaintext highlighter-rouge">perf</code> uses in memory and renders in multiples of <code class="language-plaintext highlighter-rouge">PAGE_SIZE</code> (usually 4kB).</li>
  <li>Replace the command <code class="language-plaintext highlighter-rouge">--call-tree dwarf</code> with <code class="language-plaintext highlighter-rouge">--call-tree fp</code> to generate a call tree report that provides a hierarchical view of function calls within the program, showing how functions are called and the relationships between different functions.</li>
</ul>

<p>Overall, these practices help you understand your program’s behavior, identify bottlenecks, and improve performance in your Swift applications.</p>


  
</article>

</main>

<footer role="contentinfo">
  <div class="footer-content">
    
    <p class="copyright">Copyright © 2025 Apple Inc. All rights reserved.</p>
    <p class="trademark">Swift and the Swift logo are trademarks of Apple Inc.</p>
    <p class="privacy">
      <a href="//www.apple.com/privacy/privacy-policy/">Privacy Policy</a>
      <a href="//www.apple.com/legal/privacy/en-ww/cookies/">Cookies</a>
      <a href="/openapi">API</a>
    </p>
  </div>
  <div class="footer-other">
    <form
      class="color-scheme-toggle"
      role="radiogroup"
      tabindex="0"
      id="color-scheme-toggle"
    >
      <legend class="visuallyhidden">Color scheme preference</legend>
      <label for="scheme-light">
        <input id="scheme-light" type="radio" name="color-scheme-preference" value="light">
        <span class="color-scheme-toggle-label">Light</span>
      </label>
      <label for="scheme-dark">
        <input id="scheme-dark" type="radio" name="color-scheme-preference" value="dark">
        <span class="color-scheme-toggle-label">Dark</span>
      </label>
      <label for="scheme-auto" id="scheme-auto-wrapper">
        <input id="scheme-auto" type="radio" name="color-scheme-preference" value="auto">
        <span class="color-scheme-toggle-label">Auto</span>
      </label>
    </form>
    <aside>
      <a href="https://x.com/swiftlang" rel="me" title="Follow @SwiftLang on X"><i class="x"></i></a>
      <a href="https://bsky.app/profile/swift.org" rel="me" title="Follow @swift.org on Bluesky"><i class="bluesky"></i></a>
      <a href="https://mastodon.social/@swiftlang" rel="me" title="Follow @swiftLang on Mastodon"><i class="mastodon"></i></a>
      <a href="/atom.xml" title="Subscribe to Site Updates"><i class="feed"></i></a>
    </aside>
  </div>
</footer>


<script src="/swift-org-website/pr-preview/pr-1//assets/javascripts/application.js"></script>
<!-- metrics -->
<script>
    /* RSID: */
    var s_account="awdswiftorg"
</script>

<!-- /metrics -->
</body>
</html>
