<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>Swift.org - Debugging Memory Leaks and Usage</title>
  
  <meta name="author" content="Apple Inc." />
  <meta name="viewport" content="width=device-width initial-scale=1" />
  
  <link rel="license" href="/swift-org-website/pr-preview/pr-1//LICENSE.txt" />
  <link rel="stylesheet" media="all" href="/swift-org-website/pr-preview/pr-1//assets/stylesheets/application.css" />
  <link rel="shortcut icon" sizes="16x16 24x24 32x32 48x48 64x64" type="image/vnd.microsoft.icon" href="/swift-org-website/pr-preview/pr-1//favicon.ico" />
  <link rel="apple-touch-icon" href="/swift-org-website/pr-preview/pr-1//apple-touch-icon.png" />
  <link rel="apple-touch-icon" sizes="57x57" href="/swift-org-website/pr-preview/pr-1//apple-touch-icon-57x57.png" />
  <link rel="apple-touch-icon" sizes="72x72" href="/swift-org-website/pr-preview/pr-1//apple-touch-icon-72x72.png" />
  <link rel="apple-touch-icon" sizes="76x76" href="/swift-org-website/pr-preview/pr-1//apple-touch-icon-76x76.png" />
  <link rel="apple-touch-icon" sizes="114x114" href="/swift-org-website/pr-preview/pr-1//apple-touch-icon-114x114.png" />
  <link rel="apple-touch-icon" sizes="120x120" href="/swift-org-website/pr-preview/pr-1//apple-touch-icon-120x120.png" />
  <link rel="apple-touch-icon" sizes="144x144" href="/swift-org-website/pr-preview/pr-1//apple-touch-icon-144x144.png" />
  <link rel="apple-touch-icon" sizes="152x152" href="/swift-org-website/pr-preview/pr-1//apple-touch-icon-152x152.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/swift-org-website/pr-preview/pr-1//apple-touch-icon-180x180.png" />
  <link rel="mask-icon" href="/swift-org-website/pr-preview/pr-1//assets/images/icon-swift.svg" color="#F05339" />
  

  
  <link rel="canonical" href="https://shahmishal.github.io/swift-org-website/pr-preview/pr-1//documentation/server/guides/memory-leaks-and-usage.html" />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@SwiftLang" />
  
  <meta name="twitter:title" content="Swift.org" />
  <meta name="twitter:description" content="Swift is a general-purpose programming language built using a modern approach to safety, performance, and software design patterns." />
  

  <meta property="og:site_name" content="Swift.org" />
  <meta property="og:image" content="https://shahmishal.github.io/apple-touch-icon-180x180.png" />
  
  
  <meta property="og:title" content="Swift.org" />
  <meta property="og:url" content="https://shahmishal.github.io" />
  <meta property="og:description" content="Swift is a general-purpose programming language built using a modern approach to safety, performance, and software design patterns." />
  
</head>

<body>

<script src="/swift-org-website/pr-preview/pr-1//assets/javascripts/color-scheme-toggle.js"></script>
<header class="site-navigation">
  <div class="wrapper">
    <h1 id="logo">
      <a href="/" title="Swift.org">
        <svg xmlns="http://www.w3.org/2000/svg" xml:space="preserve" viewBox="0 0 191.186 59.391"><path fill="#F05138" d="M59.387 16.45a82.463 82.463 0 0 0-.027-1.792c-.035-1.301-.112-2.614-.343-3.9-.234-1.307-.618-2.523-1.222-3.71a12.464 12.464 0 0 0-5.453-5.452C51.156.992 49.941.609 48.635.374c-1.288-.232-2.6-.308-3.902-.343a85.714 85.714 0 0 0-1.792-.027C42.23 0 41.52 0 40.813 0H18.578c-.71 0-1.419 0-2.128.004-.597.004-1.195.01-1.792.027-.325.009-.651.02-.978.036-.978.047-1.959.133-2.924.307-.98.176-1.908.436-2.811.81A12.503 12.503 0 0 0 3.89 3.89a12.46 12.46 0 0 0-2.294 3.158C.992 8.235.61 9.45.374 10.758c-.231 1.286-.308 2.599-.343 3.9a85.767 85.767 0 0 0-.027 1.792C-.001 17.16 0 17.869 0 18.578v22.235c0 .71 0 1.418.004 2.128.004.597.01 1.194.027 1.791.035 1.302.112 2.615.343 3.901.235 1.307.618 2.523 1.222 3.71a12.457 12.457 0 0 0 5.453 5.453c1.186.603 2.401.986 3.707 1.22 1.287.232 2.6.31 3.902.344.597.016 1.195.023 1.793.027.709.005 1.417.004 2.127.004h22.235c.709 0 1.418 0 2.128-.004.597-.004 1.194-.011 1.792-.027 1.302-.035 2.614-.112 3.902-.343 1.306-.235 2.521-.618 3.707-1.222a12.461 12.461 0 0 0 5.453-5.452c.604-1.187.987-2.403 1.222-3.71.231-1.286.308-2.6.343-3.9.016-.598.023-1.194.027-1.792.004-.71.004-1.419.004-2.129V18.578c0-.71 0-1.419-.004-2.128z"/><path fill="#FFF" d="m47.06 36.66-.004-.004c.066-.224.134-.446.191-.675 2.465-9.821-3.55-21.432-13.731-27.546 4.461 6.048 6.434 13.374 4.681 19.78-.156.571-.344 1.12-.552 1.653-.225-.148-.51-.316-.89-.527 0 0-10.127-6.252-21.103-17.312-.288-.29 5.852 8.777 12.822 16.14-3.284-1.843-12.434-8.5-18.227-13.802.712 1.187 1.558 2.33 2.489 3.43C17.573 23.932 23.882 31.5 31.44 37.314c-5.31 3.25-12.814 3.502-20.285.003a30.646 30.646 0 0 1-5.193-3.098c3.162 5.058 8.033 9.423 13.96 11.97 7.07 3.039 14.1 2.833 19.336.05l-.004.007c.024-.016.055-.032.08-.047.214-.116.428-.234.636-.358 2.516-1.306 7.485-2.63 10.152 2.559.654 1.27 2.041-5.46-3.061-11.74z"/><path id="logotype" d="M81.93 38.542c.465 4.12 4.394 6.822 9.852 6.822 5.185 0 8.924-2.701 8.924-6.44 0-3.22-2.265-5.185-7.478-6.495l-5.048-1.282c-7.26-1.801-10.534-5.077-10.534-10.48 0-6.658 5.813-11.27 14.082-11.27 8.022 0 13.726 4.639 13.917 11.325h-5.32c-.41-4.093-3.74-6.604-8.734-6.604-4.94 0-8.378 2.538-8.378 6.249 0 2.892 2.13 4.612 7.369 5.95l4.202 1.09c8.133 1.993 11.462 5.159 11.462 10.863 0 7.259-5.759 11.816-14.928 11.816-8.514 0-14.327-4.53-14.763-11.543h5.376zM140.049 49.43h-5.35l-6.249-21.776h-.109L122.12 49.43h-5.348l-7.914-28.518h5.184l5.513 22.896h.11l6.221-22.896h5.021l6.277 22.896h.11l5.512-22.896h5.13L140.05 49.43zM151.39 13.244c0-1.718 1.419-3.11 3.138-3.11 1.746 0 3.165 1.392 3.165 3.11 0 1.72-1.419 3.139-3.165 3.139a3.157 3.157 0 0 1-3.139-3.139zm.545 7.669h5.213V49.43h-5.213V20.913zM191.186 25.116v-4.204h-5.513v-6.821h-5.185v6.821h-9.964v-2.51c.027-2.538 1.01-3.603 3.357-3.603.764 0 1.528.083 2.156.192v-4.094a18.193 18.193 0 0 0-2.756-.218c-5.568 0-7.915 2.32-7.915 7.642v2.591h-3.983v4.204h3.983V49.43h5.185V25.116H180.488v16.838c0 5.512 2.101 7.64 7.559 7.64 1.174 0 2.51-.082 3.111-.218v-4.257c-.355.055-1.392.137-1.965.137-2.428 0-3.52-1.147-3.52-3.712V25.116h5.513z"/></svg>

      </a>
    </h1>

    <nav role="navigation">
      <ul class="navigation-links">
        
          <li class="nav-item">
            
              <span class="">
                
                  <a href="/getting-started/" data-text="Get Started">Get Started</a>
                
                
              </span>
            
            
          </li>
        
          <li class="nav-item">
            
              <span class="">
                
                  <a href="/blog/" data-text="Blog">Blog</a>
                
                
              </span>
            
            
          </li>
        
          <li class="nav-item">
            
              <span class="">
                
                  <a href="/documentation/" data-text="Documentation">Documentation</a>
                
                
              </span>
            
            
          </li>
        
          <li class="nav-item">
            
              <span class="">
                
                  <a href="/packages/" data-text="Packages">Packages</a>
                
                
              </span>
            
            
          </li>
        
          <li class="nav-item">
            
              <span class="">
                
                  <a href="/tools/" data-text="Tools">Tools</a>
                
                
              </span>
            
            
          </li>
        
          <li class="nav-item">
            
              <span class="">
                
                  <a href="/community/" data-text="Community">Community</a>
                
                
                  <i>&#9663;</i>
                
              </span>
            
            
              <ul class="nav-submenu" role="menu">
                
                  
                    
                    <li role="presentation">
                    
                      <a href="/community/" role="menuitem">Overview</a>
                    </li>
                  
                
                  
                    
                    <li role="presentation">
                    
                      <a href="/swift-evolution/" role="menuitem">Swift Evolution</a>
                    </li>
                  
                
                  
                    
                    <li role="presentation">
                    
                      <a href="/diversity/" role="menuitem">Diversity</a>
                    </li>
                  
                
                  
                    
                    <li role="presentation">
                    
                      <a href="/mentorship/" role="menuitem">Mentorship</a>
                    </li>
                  
                
                  
                    
                    <li role="presentation">
                    
                      <a href="/contributing/" role="menuitem">Contributing</a>
                    </li>
                  
                
                  
                  <li class="nav-section">Steering Groups</li>
                  
                
                  
                    
                    <li role="presentation">
                    
                      <a href="/language-steering-group/" role="menuitem">Language</a>
                    </li>
                  
                
                  
                    
                    <li role="presentation">
                    
                      <a href="/platform-steering-group/" role="menuitem">Platform</a>
                    </li>
                  
                
                  
                  <li class="nav-section">Workgroups</li>
                  
                
                  
                    
                    <li role="presentation">
                    
                      <a href="/contributor-experience-workgroup/" role="menuitem">Contributor Experience</a>
                    </li>
                  
                
                  
                    
                    <li role="presentation">
                    
                      <a href="/sswg/" role="menuitem">Server</a>
                    </li>
                  
                
                  
                    
                    <li role="presentation">
                    
                      <a href="/website/" role="menuitem">Website</a>
                    </li>
                  
                
                  
                    
                    <li role="presentation">
                    
                      <a href="/cxx-interop-workgroup/" role="menuitem">C++ Interoperability</a>
                    </li>
                  
                
                  
                    
                    <li role="presentation">
                    
                      <a href="/documentation-workgroup/" role="menuitem">Documentation</a>
                    </li>
                  
                
                  
                    
                    <li role="presentation">
                    
                      <a href="/foundation-workgroup/" role="menuitem">Foundation</a>
                    </li>
                  
                
                  
                  <li class="nav-section">Governance</li>
                  
                
                  
                    
                    <li role="presentation">
                    
                      <a href="/code-of-conduct/" role="menuitem">Code of Conduct</a>
                    </li>
                  
                
                  
                    
                    <li role="presentation">
                    
                      <a href="/legal/license.html" role="menuitem">License</a>
                    </li>
                  
                
                  
                    
                    <li role="presentation">
                    
                      <a href="/support/security.html" role="menuitem">Security</a>
                    </li>
                  
                
              </ul>
            
          </li>
        
          <li class="nav-item nav-cta">
            
              <a href="/install/" data-text="Install">Install</a>
            
            
          </li>
        
      </ul>
      <button id="menu-toggle" class="menu-item menu-toggle open" aria-expanded="false" aria-label="Toggle Navigation Menu"></button>
    </nav>
  </div>

  <nav class="mobile-navigation" role="navigation">
    <ul class="mobile-navigation-links">
      
        <li class="nav-item">
          <div class="link-container">
            
              <a href="/getting-started/">Get Started</a>
              

            
          </div>
          
        </li>
      
        <li class="nav-item">
          <div class="link-container">
            
              <a href="/blog/">Blog</a>
              

            
          </div>
          
        </li>
      
        <li class="nav-item">
          <div class="link-container">
            
              <a href="/documentation/">Documentation</a>
              

            
          </div>
          
        </li>
      
        <li class="nav-item">
          <div class="link-container">
            
              <a href="/packages/">Packages</a>
              

            
          </div>
          
        </li>
      
        <li class="nav-item">
          <div class="link-container">
            
              <a href="/tools/">Tools</a>
              

            
          </div>
          
        </li>
      
        <li class="nav-item">
          <div class="link-container">
            
              <a href="/community/">Community</a>
              

            
              <button class="section-toggle" aria-expanded="false" aria-label="Toggle Community Section">
                &#9663;
              </button>
            
          </div>
          
            <ul class="section-menu">
              
                
                  
                    <li>
                  
                    <a href="/community/">Overview</a>
                  </li>
                
              
                
                  
                    <li>
                  
                    <a href="/swift-evolution/">Swift Evolution</a>
                  </li>
                
              
                
                  
                    <li>
                  
                    <a href="/diversity/">Diversity</a>
                  </li>
                
              
                
                  
                    <li>
                  
                    <a href="/mentorship/">Mentorship</a>
                  </li>
                
              
                
                  
                    <li>
                  
                    <a href="/contributing/">Contributing</a>
                  </li>
                
              
                
                  <li class="nav-section">Steering Groups</li>
                
              
                
                  
                    <li>
                  
                    <a href="/language-steering-group/">Language</a>
                  </li>
                
              
                
                  
                    <li>
                  
                    <a href="/platform-steering-group/">Platform</a>
                  </li>
                
              
                
                  <li class="nav-section">Workgroups</li>
                
              
                
                  
                    <li>
                  
                    <a href="/contributor-experience-workgroup/">Contributor Experience</a>
                  </li>
                
              
                
                  
                    <li>
                  
                    <a href="/sswg/">Server</a>
                  </li>
                
              
                
                  
                    <li>
                  
                    <a href="/website/">Website</a>
                  </li>
                
              
                
                  
                    <li>
                  
                    <a href="/cxx-interop-workgroup/">C++ Interoperability</a>
                  </li>
                
              
                
                  
                    <li>
                  
                    <a href="/documentation-workgroup/">Documentation</a>
                  </li>
                
              
                
                  
                    <li>
                  
                    <a href="/foundation-workgroup/">Foundation</a>
                  </li>
                
              
                
                  <li class="nav-section">Governance</li>
                
              
                
                  
                    <li>
                  
                    <a href="/code-of-conduct/">Code of Conduct</a>
                  </li>
                
              
                
                  
                    <li>
                  
                    <a href="/legal/license.html">License</a>
                  </li>
                
              
                
                  
                    <li>
                  
                    <a href="/support/security.html">Security</a>
                  </li>
                
              
            </ul>
          
        </li>
      
        <li class="nav-item">
          <div class="link-container">
            
              <a href="/install/">Install</a>
              

            
          </div>
          
        </li>
      
    </ul>
  </nav>
 </header>

<main role="main">
  <article class="page">
  
    
      <header>
        <h1>Debugging Memory Leaks and Usage</h1>
      </header>
    
  

  <h1 id="overview">Overview</h1>

<p>Debugging memory leaks and usage helps you identify and resolve issues related to memory management in an application. Memory leaks occur when memory is allocated but not properly deallocated, leading to a gradual increase in memory usage over time. This can severely impact an application’s performance and stability.</p>

<p>It’s important to note, however, that a gradual increase in memory usage over time doesn’t always indicate a leak. Instead, it may be the memory profile of the application. For example, when an application’s cache gradually fills over time it shows the same gradual increase in memory. Accordingly, configuring the cache so it doesn’t expand beyond a designated limit will cause the memory usage to plateau. Additionally, allocator libraries don’t always immediately return memory feedback to the system due to performance or other reasons. But it will stabilize over time.</p>

<h2 id="tools-and-techniques">Tools and techniques</h2>

<p>Debugging memory leaks in Swift on macOS and Linux environments can be done using different tools and techniques, each with distinct strengths and usability.</p>

<h3 id="basic-troubleshooting-includes">Basic troubleshooting includes:</h3>

<ul>
  <li>Using profiling tools.</li>
  <li>Reviewing code and identifying potential leaks.</li>
  <li>Enabling debug memory allocation features.</li>
</ul>

<p><strong>1. Using profiling tools</strong> provided by the respective operating systems and development environments to identify and analyze memory usage.</p>

<p><em>For macOS</em>: <a href="https://developer.apple.com/documentation/xcode/gathering-information-about-memory-use#Inspect-the-debug-memory-graph">Memory Graph Debugger</a> and this <a href="https://developer.apple.com/videos/play/wwdc2021/10180/">Detect and diagnose memory issues</a> video are helpful. You can also use the <a href="https://help.apple.com/instruments/mac/10.0/#/dev022f987b">Xcode Instruments</a> tool for various profiling instruments including the <a href="https://developer.apple.com/documentation/xcode/gathering-information-about-memory-use#Profile-your-app-using-the-Allocations-instrument">Allocations instrument</a> to track memory allocation and deallocation in your Swift code.</p>

<p><em>For Linux</em>: You can use tools like <a href="https://valgrind.org/">Valgrind</a> or <a href="https://github.com/KDE/heaptrack">Heaptrack</a> to profile your application as shown in the examples below. Although these tools are primarily used for C/C++ code, they can also work with Swift.</p>

<p><strong>2. Reviewing code and identifying potential leaks</strong> to examine your code for any potential areas where memory leaks may occur. Common sources of leaks include retained references or unbalanced retain-release cycles, which rarely apply to Swift since it performs <a href="https://docs.swift.org/swift-book/documentation/the-swift-programming-language/automaticreferencecounting/">automatic reference counting (ARC)</a>.</p>

<blockquote>
  <p>Note: Memory leaks can occur in Swift if there are substantial reference cycles between objects that involve closures or if objects hold references to external resources that are not released properly. However, the likelihood of such issues is significantly reduced through the automatic memory management’s ability to add and remove references, making sources of leaks like retained references and unbalanced retain-release cycles less common in Swift code.</p>
</blockquote>

<p><strong>3. Enabling debug memory allocation features</strong> allows you to get additional information about objects and their memory allocations.</p>

<p><em>On macOS</em>: You can enable Zombie Objects using Xcode or use <a href="https://developer.apple.com/videos/play/wwdc2022/10106/">MallocStackLogging</a> to detect over-released or accessed deallocated objects.</p>

<p>To enable Zombie Objects:</p>
<ol>
  <li>Open your Xcode project.</li>
  <li>Go to the <strong>Edit Scheme</strong> menu by clicking on the scheme dropdown in the toolbar.</li>
  <li>In the scheme editor window, select the <strong>Run</strong> tab.</li>
  <li>Choose the <strong>Diagnostics</strong> tab.</li>
  <li>Under <strong>Memory Management</strong>, check the box next to <strong>Enable Zombie Objects</strong>.</li>
</ol>

<p><em>On Linux</em>: Swift has built-in LeakSanitizer support that can be enabled using the <code class="language-plaintext highlighter-rouge">-sanitize=leak</code> compiler flag.</p>

<h2 id="troubleshooting">Troubleshooting</h2>

<p>This section aims to provide you with helpful server-side troubleshooting techniques to debug leaks and usage using <strong>Valgrind</strong>, <strong>LeakSanitizer</strong>, and <strong>Heaptrack</strong>.</p>

<p>The following <strong>example program</strong> leaks memory. We are using it as an <em>example only</em> to illustrate the various troubleshooting methods mentioned below.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public class MemoryLeaker {
   var closure: () -&gt; Void = { () }
   
   public init() {}
   
   public func doNothing() {}
   
   public func doSomethingThatLeaks() {
      self.closure = {
         // This will leak as it'll create a permanent reference cycle:
         //
         //     self -&gt; self.closure -&gt; self
         self.doNothing()
      }
   }
}
@inline(never) // just to be sure to get this in a stack trace
func myFunctionDoingTheAllocation() {
   let thing = MemoryLeaker()
   thing.doSomethingThatLeaks()
}

myFunctionDoingTheAllocation()
</code></pre></div></div>

<h3 id="debugging-leaks-with-valgrind">Debugging leaks with Valgrind</h3>
<p>Valgrind is an open-source framework for debugging and profiling Linux applications. It provides several tools, including Memcheck, which can detect memory leaks, invalid memory accesses, and other memory errors. Although Valgrind is primarily focused on C/C++ applications, it can also be used with Swift on Linux.</p>

<p>To debug memory leaks for Swift on Linux using Valgrind, install it on your system.</p>

<ol>
  <li>Install Swift on your Linux system. You can download and install Swift from the <a href="https://swift.org/download/">official website</a>.</li>
  <li>Install Valgrind on your Linux system by using your package manager. For example, if you are using Ubuntu, you can run the following command:
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo apt-get install valgrind
</code></pre></div>    </div>
  </li>
  <li>Once Valgrind is installed, run the following command:
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>valgrind --leak-check=full swift run
</code></pre></div>    </div>
  </li>
</ol>

<p>The <code class="language-plaintext highlighter-rouge">valgrind</code> command analyzes the program for any memory leaks and shows the relevant information about the leak, including the stack trace where the allocation occurred as shown below:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>==1== Memcheck, a memory error detector
==1== Copyright (C) 2002-2017, and GNU GPL'd, by Julian Seward et al.
==1== Using Valgrind-3.13.0 and LibVEX; rerun with -h for copyright info
==1== Command: ./test
==1==
==1==
==1== HEAP SUMMARY:
==1==     in use at exit: 824 bytes in 4 blocks
==1==   total heap usage: 5 allocs, 1 frees, 73,528 bytes allocated
==1==
==1== 32 bytes in 1 blocks are definitely lost in loss record 1 of 4
==1==    at 0x4C2FB0F: malloc (in /usr/lib/valgrind/vgpreload_memcheck-amd64-linux.so)
==1==    by 0x52076B1: swift_slowAlloc (in /usr/lib/swift/linux/libswiftCore.so)
==1==    by 0x5207721: swift_allocObject (in /usr/lib/swift/linux/libswiftCore.so)
==1==    by 0x108E58: $s4test12MemoryLeakerCACycfC (in /tmp/test)
==1==    by 0x10900E: $s4test28myFunctionDoingTheAllocationyyF (in /tmp/test)
==1==    by 0x108CA3: main (in /tmp/test)
==1==
==1== LEAK SUMMARY:
==1==    definitely lost: 32 bytes in 1 blocks
==1==    indirectly lost: 0 bytes in 0 blocks
==1==      possibly lost: 0 bytes in 0 blocks
==1==    still reachable: 792 bytes in 3 blocks
==1==         suppressed: 0 bytes in 0 blocks
==1== Reachable blocks (those to which a pointer was found) are not shown.
==1== To see them, rerun with: --leak-check=full --show-leak-kinds=all
==1==
==1== For counts of detected and suppressed errors, rerun with: -v
==1== ERROR SUMMARY: 1 errors from 1 contexts (suppressed: 0 from 0)
</code></pre></div></div>

<p>The following trace block (from above) indicates a memory leak.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>==1== 32 bytes in 1 blocks are definitely lost in loss record 1 of 4
==1==    at 0x4C2FB0F: malloc (in /usr/lib/valgrind/vgpreload_memcheck-amd64-linux.so)
==1==    by 0x52076B1: swift_slowAlloc (in /usr/lib/swift/linux/libswiftCore.so)
==1==    by 0x5207721: swift_allocObject (in /usr/lib/swift/linux/libswiftCore.so)
==1==    by 0x108E58: $s4test12MemoryLeakerCACycfC (in /tmp/test)
==1==    by 0x10900E: $s4test28myFunctionDoingTheAllocationyyF (in /tmp/test)
==1==    by 0x108CA3: main (in /tmp/test)
</code></pre></div></div>

<p>However, since Swift uses name mangling for function and symbol names, the stack traces may not be straightforward to understand.</p>

<p>To demangle the Swift symbols in the stack traces, run the <code class="language-plaintext highlighter-rouge">swift demangle</code> command:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>swift demangle &lt;mangled_symbol&gt;
</code></pre></div></div>

<p>Replace <code class="language-plaintext highlighter-rouge">&lt;mangled_symbol&gt;</code> with the mangled symbol name shown in the stack trace. For example:</p>

<p><code class="language-plaintext highlighter-rouge">swift demangle $s4test12MemoryLeakerCACycfC</code></p>

<p><strong>Note:</strong> <code class="language-plaintext highlighter-rouge">swift demangle</code> is a Swift command line utility and should be available if you have the Swift toolchain installed.</p>

<p>The utility will demangle the symbol and display a human-readable version as follows:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>==1== 32 bytes in 1 blocks are definitely lost in loss record 1 of 4
==1==    at 0x4C2FB0F: malloc (in /usr/lib/valgrind/vgpreload_memcheck-amd64-linux.so)
==1==    by 0x52076B1: swift_slowAlloc (in /usr/lib/swift/linux/libswiftCore.so)
==1==    by 0x5207721: swift_allocObject (in /usr/lib/swift/linux/libswiftCore.so)
==1==    by 0x108E58: test.MemoryLeaker.__allocating_init() -&gt; test.MemoryLeaker (in /tmp/test)
==1==    by 0x10900E: test.myFunctionDoingTheAllocation() -&gt; () (in /tmp/test)
==1==    by 0x108CA3: main (in /tmp/test)
</code></pre></div></div>

<p>By analyzing the demangled symbols, we can understand which part of the code is responsible for the memory leak. In this example, the <code class="language-plaintext highlighter-rouge">valgrind</code> command indicates the allocation that leaked is coming from:</p>

<p><code class="language-plaintext highlighter-rouge">test.myFunctionDoingTheAllocation</code> calling <code class="language-plaintext highlighter-rouge">test.MemoryLeaker.__allocating_init()</code></p>

<h4 id="limitations">Limitations</h4>

<ul>
  <li>The <code class="language-plaintext highlighter-rouge">valgrind</code> command doesn’t understand the bit-packing used in many Swift data types like <code class="language-plaintext highlighter-rouge">String</code> or when <code class="language-plaintext highlighter-rouge">enums</code> are created with associated values. Consequently, using the <code class="language-plaintext highlighter-rouge">valgrind</code> command sometimes reports memory errors or leaks that do not exist, and false negatives occur when it fails to detect actual issues.</li>
  <li>The <code class="language-plaintext highlighter-rouge">valgrind</code> command makes your program run exceptionally slow (possibly 100x slower), which may hinder your ability to reproduce the problem and analyze the performance.</li>
  <li>Valgrind is primarily supported on Linux. Its support for other platforms, such as macOS or iOS, may be limited or nonexistent.</li>
</ul>

<h3 id="debugging-leaks-with-leaksanitizer">Debugging leaks with LeakSanitizer</h3>
<p>LeakSanitizer is a memory leak detector that is integrated into <a href="https://developer.apple.com/documentation/xcode/diagnosing-memory-thread-and-crash-issues-early">AddressSanitizer</a>. To debug memory leaks using LeakSanitizer with Address Sanitizer enabled on Swift, you will need to set the appropriate environment variable, compile your Swift package with the necessary options, and then run your application.</p>

<p>Here are the steps:</p>

<ol>
  <li>Open a terminal session and navigate to your Swift package directory.</li>
  <li>Set the <code class="language-plaintext highlighter-rouge">ASAN_OPTIONS</code> environment variable to enable AddressSanitizer and configure its behavior. You can do this by running the command:
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>export ASAN_OPTIONS=detect_leaks=1
</code></pre></div>    </div>
  </li>
  <li>Run <code class="language-plaintext highlighter-rouge">swift build</code> with the additional option to enable <a href="https://developer.apple.com/documentation/xcode/diagnosing-memory-thread-and-crash-issues-early">Address Sanitizer</a>:
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>swift build --sanitize=address
</code></pre></div>    </div>
  </li>
</ol>

<p>The build process will compile your code with AddressSanitizer enabled, which automatically looks for leaked memory blocks. If any memory leaks during the build are detected, it will output the information (similar to Valgrind) as shown in the example below:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>=================================================================
==478==ERROR: LeakSanitizer: detected memory leaks

Direct leak of 32 byte(s) in 1 object(s) allocated from:
    #0 0x55f72c21ac8d  (/tmp/test+0x95c8d)
    #1 0x7f7e44e686b1  (/usr/lib/swift/linux/libswiftCore.so+0x3cb6b1)
    #2 0x55f72c24b2ce  (/tmp/test+0xc62ce)
    #3 0x55f72c24a4c3  (/tmp/test+0xc54c3)
    #4 0x7f7e43aecb96  (/lib/x86_64-linux-gnu/libc.so.6+0x21b96)

SUMMARY: AddressSanitizer: 32 byte(s) leaked in 1 allocation(s).
</code></pre></div></div>

<p>Currently, the output doesn’t provide a human-readable representation of the function names because <a href="https://github.com/swiftlang/swift/issues/55046">LeakSanitizer doesn’t symbolicate stack traces on Linux</a>. However, you can symbolicate it using <code class="language-plaintext highlighter-rouge">llvm-symbolizer</code> or <code class="language-plaintext highlighter-rouge">addr2line</code> if you have <code class="language-plaintext highlighter-rouge">binutils</code> installed.</p>

<p>To install <code class="language-plaintext highlighter-rouge">binutils</code> for Swift on a server running Linux, follow these steps:</p>

<p>Step 1: Connect to your Swift server through SSH using a terminal.</p>

<p>Step 2: Update the package lists by running the following command:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo apt update
</code></pre></div></div>

<p>Step 3: Install <code class="language-plaintext highlighter-rouge">binutils</code> by running the following command:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo apt install binutils
</code></pre></div></div>

<p>This will install <code class="language-plaintext highlighter-rouge">binutils</code> and its related tools for working with binaries, object files, and libraries, which can be useful for developing and debugging Swift applications on Linux.</p>

<p>You can now run the following command to demangle the symbols in the stack traces:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># /tmp/test+0xc62ce
addr2line -e /tmp/test -a 0xc62ce -ipf | swift demangle
</code></pre></div></div>

<p>In this example, the allocation that leaked is coming from:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0x00000000000c62ce: test.myFunctionDoingTheAllocation() -&gt; () at crtstuff.c:?
</code></pre></div></div>

<h4 id="limitations-1">Limitations</h4>

<ul>
  <li>LeakSanitizer may not be as effective in detecting and reporting all types of memory leaks in Swift code compared to languages like C or C++.</li>
  <li>False positives occur when LeakSanitizer reports a memory leak that does not exist.</li>
  <li>LeakSanitizer is primarily supported on macOS and Linux. While it is possible to use LeakSanitizer on iOS or other platforms that support Swift, there may be limitations or platform-specific issues that need to be considered.</li>
  <li>Enabling Address Sanitizer and LeakSanitizer in your Swift project can have a performance impact. It is recommended to use LeakSanitizer for targeted analysis and debugging rather than continuously running it in production environments.</li>
</ul>

<h3 id="debugging-transient-memory-usage-with-heaptrack">Debugging transient memory usage with Heaptrack</h3>
<p><a href="https://github.com/KDE/heaptrack">Heaptrack</a> is an open-source heap memory profiler tool that helps find and analyze memory leaks and usage with less overhead than Valgrind. It also allows for analyzing and debugging transient memory usage in your application. However, it may significantly impact performance by overloading the allocator.</p>

<p>A GUI front-end analyzer <code class="language-plaintext highlighter-rouge">heaptrack_gui</code> is available in addition to command line access. The analyzer allows for diffing between two different runs of your application to troubleshoot variations in <code class="language-plaintext highlighter-rouge">malloc</code> behavior between the <code class="language-plaintext highlighter-rouge">feature branch</code> and <code class="language-plaintext highlighter-rouge">main</code>.</p>

<p>Using a different example, here’s a short how-to using <a href="https://www.swift.org/download/">Ubuntu</a> to analyze transient usage.</p>

<p>Step 1: Install <code class="language-plaintext highlighter-rouge">heaptrack</code> by running this command:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo apt-get install heaptrack
</code></pre></div></div>

<p>Step 2: Run the binary twice using <code class="language-plaintext highlighter-rouge">heaptrack</code>. The first run provides a baseline for <code class="language-plaintext highlighter-rouge">main</code>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>heaptrack .build/x86_64-unknown-linux-gnu/release/test_1000_autoReadGetAndSet
heaptrack output will be written to "/tmp/.nio_alloc_counter_tests_GRusAy/heaptrack.test_1000_autoReadGetAndSet.84341.gz"
starting application, this might take some time...
...
heaptrack stats:
    allocations:              319347
    leaked allocations:       107
    temporary allocations:    68
Heaptrack finished! Now run the following to investigate the data:

  heaptrack --analyze "/tmp/.nio_alloc_counter_tests_GRusAy/heaptrack.test_1000_autoReadGetAndSet.84341.gz"
</code></pre></div></div>

<p>Step 3: Then run it a second time for the <code class="language-plaintext highlighter-rouge">feature branch</code> by changing the branch and recompiling.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>heaptrack .build/x86_64-unknown-linux-gnu/release/test_1000_autoReadGetAndSet
heaptrack output will be written to "/tmp/.nio_alloc_counter_tests_GRusAy/heaptrack.test_1000_autoReadGetAndSet.84372.gz"
starting application, this might take some time...
...
heaptrack stats:
    allocations:              673989
    leaked allocations:       117
    temporary allocations:    341011
Heaptrack finished! Now run the following to investigate the data:

  heaptrack --analyze "/tmp/.nio_alloc_counter_tests_GRusAy/heaptrack.test_1000_autoReadGetAndSet.84372.gz"
ubuntu@ip-172-31-25-161 /t/.nio_alloc_counter_tests_GRusAy&gt;
</code></pre></div></div>

<p>The output shows <code class="language-plaintext highlighter-rouge">673989</code> allocations in the <code class="language-plaintext highlighter-rouge">feature branch</code> version and <code class="language-plaintext highlighter-rouge">319347</code> in <code class="language-plaintext highlighter-rouge">main</code>, indicating a regression.</p>

<p>Step 4: Run the following command to analyze the output as a diff from these runs using <code class="language-plaintext highlighter-rouge">heaptrack_print</code> and pipe it through <code class="language-plaintext highlighter-rouge">swift demangle</code> for readability:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>heaptrack_print -T -d heaptrack.test_1000_autoReadGetAndSet.84341.gz heaptrack.test_1000_autoReadGetAndSet.84372.gz | swift demangle
</code></pre></div></div>

<p><strong>Note:</strong> <code class="language-plaintext highlighter-rouge">-T</code> outputs the temporary allocations, providing transient allocations and not leaks. If leaks are detected, remove <code class="language-plaintext highlighter-rouge">-T</code>.</p>

<p>Scroll down to see the transient allocations (output may be long):</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MOST TEMPORARY ALLOCATIONS
307740 temporary allocations of 290324 allocations in total (106.00%) from
swift_slowAlloc
  in /home/ubuntu/bin/usr/lib/swift/linux/libswiftCore.so
43623 temporary allocations of 44553 allocations in total (97.91%) from:
    swift_allocObject
      in /home/ubuntu/bin/usr/lib/swift/linux/libswiftCore.so
    NIO.ServerBootstrap.(bind0 in _C131C0126670CF68D8B594DDFAE0CE57)(makeServerChannel: (NIO.SelectableEventLoop, NIO.EventLoopGroup) throws -&gt; NIO.ServerSocketChannel, _: (NIO.EventLoop, NIO.ServerSocketChannel) -&gt; NIO.EventLoopFuture&lt;()&gt;) -&gt; NIO.EventLoopFuture&lt;NIO.Channel&gt;
      at /home/ubuntu/swiftnio/swift-nio/Sources/NIO/Bootstrap.swift:295
      in /tmp/.nio_alloc_counter_tests_GRusAy/.build/x86_64-unknown-linux-gnu/release/test_1000_autoReadGetAndSet
    merged NIO.ServerBootstrap.bind(host: Swift.String, port: Swift.Int) -&gt; NIO.EventLoopFuture&lt;NIO.Channel&gt;
      in /tmp/.nio_alloc_counter_tests_GRusAy/.build/x86_64-unknown-linux-gnu/release/test_1000_autoReadGetAndSet
    NIO.ServerBootstrap.bind(host: Swift.String, port: Swift.Int) -&gt; NIO.EventLoopFuture&lt;NIO.Channel&gt;
      in /tmp/.nio_alloc_counter_tests_GRusAy/.build/x86_64-unknown-linux-gnu/release/test_1000_autoReadGetAndSet
    Test_test_1000_autoReadGetAndSet.run(identifier: Swift.String) -&gt; ()
      at /tmp/.nio_alloc_counter_tests_GRusAy/Sources/Test_test_1000_autoReadGetAndSet/file.swift:24
      in /tmp/.nio_alloc_counter_tests_GRusAy/.build/x86_64-unknown-linux-gnu/release/test_1000_autoReadGetAndSet
    main
      at Sources/bootstrap_test_1000_autoReadGetAndSet/main.c:18
      in /tmp/.nio_alloc_counter_tests_GRusAy/.build/x86_64-unknown-linux-gnu/release/test_1000_autoReadGetAndSet
22208 temporary allocations of 22276 allocations in total (99.69%) from:
    swift_allocObject
      in /home/ubuntu/bin/usr/lib/swift/linux/libswiftCore.so
    generic specialization &lt;Swift.UnsafeBufferPointer&lt;Swift.Int8&gt;&gt; of Swift._copyCollectionToContiguousArray&lt;A where A: Swift.Collection&gt;(A) -&gt; Swift.ContiguousArray&lt;A.Element&gt;
      in /home/ubuntu/bin/usr/lib/swift/linux/libswiftCore.so
    Swift.String.utf8CString.getter : Swift.ContiguousArray&lt;Swift.Int8&gt;
      in /home/ubuntu/bin/usr/lib/swift/linux/libswiftCore.so
    NIO.URing.getEnvironmentVar(Swift.String) -&gt; Swift.String?
      at /home/ubuntu/swiftnio/swift-nio/Sources/NIO/LinuxURing.swift:291
      in /tmp/.nio_alloc_counter_tests_GRusAy/.build/x86_64-unknown-linux-gnu/release/test_1000_autoReadGetAndSet
    NIO.URing._debugPrint(@autoclosure () -&gt; Swift.String) -&gt; ()
      at /home/ubuntu/swiftnio/swift-nio/Sources/NIO/LinuxURing.swift:297
...
22196 temporary allocations of 22276 allocations in total (99.64%) from:
</code></pre></div></div>

<p>Looking at the output above, we can see the extra transient allocations were due to extra debug printing and querying of environment variables as shown below:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NIO.URing.getEnvironmentVar(Swift.String) -&gt; Swift.String?
  at /home/ubuntu/swiftnio/swift-nio/Sources/NIO/LinuxURing.swift:291
  in /tmp/.nio_alloc_counter_tests_GRusAy/.build/x86_64-unknown-linux-gnu/release/test_1000_autoReadGetAndSet
NIO.URing._debugPrint(@autoclosure () -&gt; Swift.String) -&gt; ()
</code></pre></div></div>

<p>In this example, the debug prints are only for testing and would be removed from the code before the branch is merged.</p>

<p><strong>Tip:</strong> Heaptrack can also be <a href="https://rhel.pkgs.org/8/epel-x86_64/heaptrack-1.2.0-7.el8.x86_64.rpm.html">installed on an RPM-based distribution</a> to debug transient memory usage. You may need to consult the distribution’s documentation for the specific repository setup steps. When Heaptrack is installed correctly, it should display its version and usage information.</p>

<h4 id="limitations-2">Limitations</h4>

<ul>
  <li>It’s important to note that Heaptrack was primarily designed for C and C++ applications, so its support for Swift applications is limited.</li>
  <li>While Heaptrack can provide insights into memory allocations and deallocations in a Swift application, it may not capture certain Swift-specific memory management mechanisms like Swift’s built-in Instruments profiler.</li>
</ul>


  
</article>

</main>

<footer role="contentinfo">
  <div class="footer-content">
    
    <p class="copyright">Copyright © 2025 Apple Inc. All rights reserved.</p>
    <p class="trademark">Swift and the Swift logo are trademarks of Apple Inc.</p>
    <p class="privacy">
      <a href="//www.apple.com/privacy/privacy-policy/">Privacy Policy</a>
      <a href="//www.apple.com/legal/privacy/en-ww/cookies/">Cookies</a>
      <a href="/openapi">API</a>
    </p>
  </div>
  <div class="footer-other">
    <form
      class="color-scheme-toggle"
      role="radiogroup"
      tabindex="0"
      id="color-scheme-toggle"
    >
      <legend class="visuallyhidden">Color scheme preference</legend>
      <label for="scheme-light">
        <input id="scheme-light" type="radio" name="color-scheme-preference" value="light">
        <span class="color-scheme-toggle-label">Light</span>
      </label>
      <label for="scheme-dark">
        <input id="scheme-dark" type="radio" name="color-scheme-preference" value="dark">
        <span class="color-scheme-toggle-label">Dark</span>
      </label>
      <label for="scheme-auto" id="scheme-auto-wrapper">
        <input id="scheme-auto" type="radio" name="color-scheme-preference" value="auto">
        <span class="color-scheme-toggle-label">Auto</span>
      </label>
    </form>
    <aside>
      <a href="https://x.com/swiftlang" rel="me" title="Follow @SwiftLang on X"><i class="x"></i></a>
      <a href="https://bsky.app/profile/swift.org" rel="me" title="Follow @swift.org on Bluesky"><i class="bluesky"></i></a>
      <a href="https://mastodon.social/@swiftlang" rel="me" title="Follow @swiftLang on Mastodon"><i class="mastodon"></i></a>
      <a href="/atom.xml" title="Subscribe to Site Updates"><i class="feed"></i></a>
    </aside>
  </div>
</footer>


<script src="/swift-org-website/pr-preview/pr-1//assets/javascripts/application.js"></script>
<!-- metrics -->
<script>
    /* RSID: */
    var s_account="awdswiftorg"
</script>

<!-- /metrics -->
</body>
</html>
